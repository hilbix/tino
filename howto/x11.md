# X11 howto

## `su` => `xsu`

Problem:

You are logged on with X11 to one account and you need to run some X11 app on another account.

> Same machine, other account.

I tried, but none of the solutions out there worked for me.  Here is a short working recipe which automatically detects, which line of `xauth` is for your display:

> Do not leave away any quote!
>
> **Security Warning!**
>
> This recipe leaves `xauth` in `$OTHERACCOUNT` active.  Hence **the other account can abuse your X11 session afterwards**!
>
> There is no way to protect the MIT_MAGIC_COOKIE from being stolen by some evil `$OTHERACCOUNT` once it has been added via `xauth`.
>
> **Cleanup of the MIT_MAGIC_COOKIE afterwards is pseudo security, not giving you any protection, except that you are fooled to be secure, but you aren't!**
>
> If something is worse than no security at all it is pseudo security, which does not keep you stay alert.

```
AUTH="$(xauth list)" su --whitelist-environment=AUTH,DISPLAY - $OTHERACCOUNT
exec bash -l
while read -ra line; do xauth add "${line[@]}" && xhost >/dev/null || continue; unset AUTH; break; done <<< "$AUTH"
```

> `xauth` and `xhost` should always be available.  But if `xhost` is not what you want to use for tests,
> try some other command which immediately and always returns success if `$DISPLAY` works:
>
> `xdpyinfo`, `xmodmap`, `xdotool getmouselocation`
>
> Not suitable are commands like `xclip`, which may fail too many ways.

How to automate this recipe?

```
xsu()
{
  AUTH="$(xauth list)" su --whitelist-environment=AUTH,DISPLAY --shell="$SHELL" --pty -- - "$1" -c '
    while read -ra line;
    do
      xauth add "${line[@]}" && xhost >/dev/null || continue;
      unset AUTH;
      break;
    done <<< "$AUTH";
    [ 0 = $# ] && exec "$SHELL" -l;
    exec "$SHELL" -c "exec \"\$@\"" "$SHEll" "$@";
  ' - "${@:2}"
}
```

Then just run `xsu user` or `xsu user cmd args..`.

> This should work for all Bourne Shells.  I nearly always use `/bin/bash` with fallback to `ksh` in case `bash` is not available.

As simple as it can get.
